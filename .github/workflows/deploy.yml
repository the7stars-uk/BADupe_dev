name: Build and Deploy to Cloud Run

on:
  push:
    branches:
      - main 

permissions:
  contents: read
  id-token: write

env:
  REGION: europe-west2
  REPO_NAME: badupe-microservices-repo # The Artifact Registry repo from Step 2

jobs:
  deploy-service-a:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-badupe/providers/github-provider'
          service_account: 'github-actions-deployer@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'
          create_credentials_file: true
          audience: 'https://iam.googleapis.com/projects/553463854789/locations/global/workloadIdentityPools/github-badupe/providers/github-provider'

      # VVVV ADD THIS NEW TEMPORARY STEP VVVV
      - name: Decode OIDC Token for Debugging
        id: decode_token
        uses: actions/github-script@v6
        with:
          script: |
            const token = process.env.ACTIONS_RUNTIME_TOKEN;
            const payload = JSON.parse(Buffer.from(token.split('.')[1], 'base64').toString());
            console.log('--- OIDC Token Payload ---');
            console.log(JSON.stringify(payload, null, 2));
            console.log('--------------------------');
      # ^^^^ END OF NEW TEMPORARY STEP ^^^^

      - name: Deploy Service A
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: service-a
          region: ${{ env.REGION }}
          source: ./serp_analysis # Tell it to look in the service-a folder
          # Make sure Service A is still public
          flags: --allow-unauthenticated

  deploy-service-b:
    runs-on: ubuntu-latest
    needs: deploy-service-a # Run this job only after service-a succeeds
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-badupe/providers/github-provider'
          service_account: 'github-actions-deployer@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'
          create_credentials_file: true
          audience: 'https://iam.googleapis.com/projects/553463854789/locations/global/workloadIdentityPools/github-badupe/providers/github-provider'

      - name: Deploy Service B
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: service-b
          region: ${{ env.REGION }}
          source: ./changes_to_gads # Tell it to look in the service-b folder
          # Service B will remain private (no --allow-unauthenticated flag)
  
  deploy-service-c:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-badupe/providers/github-provider'
          service_account: 'github-actions-deployer@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'
          create_credentials_file: true
          audience: 'https://iam.googleapis.com/projects/553463854789/locations/global/workloadIdentityPools/github-badupe/providers/github-provider'

      - name: Deploy Service C
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: search_console_api_service
          region: ${{ env.REGION }}
          source: ./search_console # Tell it to look in the search_console folder
